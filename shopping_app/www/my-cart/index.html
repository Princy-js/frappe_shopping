{% extends "templates/web.html" %}

{% block page_content %}
<div class="container mt-5">
    <h1 class="mb-4">My Shopping Cart</h1>
    
    {% if cart_items %}
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in cart_items %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if item.product_image %}
                                    <img src="{{ item.product_image }}" 
                                         alt="{{ item.product_name }}" 
                                         style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;">
                                    {% endif %}
                                    <strong>{{ item.product_name }}</strong>
                                </div>
                            </td>
                            <td>â‚¹{{ item.rate }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-sm btn-secondary decrease-qty-btn" 
                                            data-product="{{ item.product }}">
                                        -
                                    </button>
                                    <span class="mx-3"><strong>{{ item.quantity }}</strong></span>
                                    <button class="btn btn-sm btn-secondary increase-qty-btn" 
                                            data-product="{{ item.product }}">
                                        +
                                    </button>
                                </div>
                            </td>
                            <td><strong>â‚¹{{ item.amount }}</strong></td>
                            <td>
                                <button class="btn btn-sm btn-danger remove-item-btn" 
                                        data-product="{{ item.product }}">
                                    Remove
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end"><strong>Total Amount:</strong></td>
                            <td colspan="2"><strong class="text-success">â‚¹{{ total_amount }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="text-end mt-3">
                <a href="/shop" class="btn btn-primary me-2">Continue Shopping</a>
                <button class="btn btn-success btn-lg" id="place-order-btn">
                    Place Order
                </button>
            </div>
        </div>
    </div>
    
    {% else %}
    <div class="alert alert-info">
        <h4>Your cart is empty!</h4>
        <p>Add some products to your cart to see them here.</p>
        <a href="/shop" class="btn btn-primary">Go to Shop</a>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Increase Quantity Buttons
    document.querySelectorAll('.increase-qty-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            let productId = this.getAttribute('data-product');
            let currentQty = parseInt(this.parentElement.querySelector('span strong').textContent);
            updateQuantity(productId, currentQty + 1);
        });
    });
    
    // Decrease Quantity Buttons
    document.querySelectorAll('.decrease-qty-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            let productId = this.getAttribute('data-product');
            let currentQty = parseInt(this.parentElement.querySelector('span strong').textContent);
            
            if (currentQty <= 1) {
                removeFromCart(productId);
            } else {
                updateQuantity(productId, currentQty - 1);
            }
        });
    });
    
    // Remove Item Buttons
    document.querySelectorAll('.remove-item-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            let productId = this.getAttribute('data-product');
            removeFromCart(productId);
        });
    });
    
    // Place Order Button
    const placeOrderBtn = document.getElementById('place-order-btn');
    if (placeOrderBtn) {
        placeOrderBtn.addEventListener('click', function() {
            placeOrder();
        });
    }
});

function updateQuantity(productId, newQty) {
    console.log("ðŸ”„ Update Quantity");
    console.log("Product:", productId);
    console.log("New Qty:", newQty);
    frappe.call({
        method: 'shopping_app.api.update_cart_quantity',
        args: {
            product: productId,
            quantity: newQty
        },
        callback: function(r) {
            if (r.message && r.message.success) {
                frappe.show_alert({
                    message: 'Quantity updated',
                    indicator: 'green'
                });
                setTimeout(function() {
                    window.location.reload();
                }, 500);
            } else {
                frappe.show_alert({
                    message: r.message.message || 'Error updating cart',
                    indicator: 'red'
                });
            }
        }
    });
}

function removeFromCart(productId) {
    frappe.confirm(
        'Remove this item from cart?',
        function() {
            frappe.call({
                method: 'shopping_app.api.remove_from_cart',
                args: {
                    product: productId
                },
                callback: function(r) {
                    if (r.message && r.message.success) {
                        frappe.show_alert({
                            message: 'Item removed from cart',
                            indicator: 'orange'
                        });
                        setTimeout(function() {
                            window.location.reload();
                        }, 1000);
                    }
                }
            });
        }
    );
}

function placeOrder() {
    frappe.confirm(
        'Are you sure you want to place this order?',
        function() {
            frappe.show_alert({
                message: 'Placing order...',
                indicator: 'blue'
            });
            
            frappe.call({
                method: 'shopping_app.api.place_order',
                callback: function(r) {
                    if (r.message && r.message.success) {
                        frappe.show_alert({
                            message: r.message.message,
                            indicator: 'green'
                        });
                        setTimeout(function() {
                            window.location.href = '/my-order';
                        }, 2000);
                    }
                }
            });
        }
    );
}
</script>
{% endblock %}